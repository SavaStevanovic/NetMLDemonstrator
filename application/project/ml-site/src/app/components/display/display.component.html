<div id="container">
  <video #videoElement class="videoElement" (timeupdate)="capture()"></video>
  <canvas #unprocessedCanvas id="unprocessedCanvas" class="videoElement"></canvas>
  <canvas #processedCanvas id="processed_canvas" class="videoElement">
  </canvas>
</div>

<div class="row">
  <button (click)="start()" class="btn btn-primary">Play</button>
  <button (click)="toggleControls()" class="btn btn-success">Toggle Controls</button>
  <button (click)="pause()" class="btn btn-warning">Pause</button>
  <button (click)="resume()" class="btn btn-info">Resume</button>
  <button (click)="sound()" class="btn btn-danger">Play with Sound</button>
  <button (click)="capture()" class="btn btn-danger">Capture</button>
</div>

<!-- <script>
  var video = document.getElementById("video");
  var stopVideo = document.getElementById("stop");
  var unp_ctx = document.getElementById('unprocessed_canvas').getContext('2d');
  var p_ctx = document.getElementById('processed_canvas').getContext('2d');
  var img = new Image();
  img.onload = function() {
    p_ctx.drawImage(img, 0, 0);
  }

  if (navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(function (stream) {
        video.addEventListener('loadedmetadata', initCanvas, false);
        video.addEventListener('timeupdate', drawFrame, false);
        video.addEventListener('ended', onend, false);
        // requestAnimationFrame(drawFrame)
        video.muted = true;
        video.srcObject = stream;


      })
      .catch(function (err0r) {
        console.log(err0r)
        console.log("Something went wrong!");
      });
  }

  stopVideo.addEventListener("click", stop, false);

  function stop(e) {
    var stream = video.srcObject;
    var tracks = stream.getTracks();

    for (var i = 0; i < tracks.length; i++) {
      var track = tracks[i];
      track.stop();
    }

    video.srcObject = null;
  }


  function initCanvas(e) {
    canvs = document.querySelectorAll('canvas').forEach(function(el) {
      el.width = video.videoWidth;
      el.height = video.videoHeight;
    });

  }

  function drawFrame() {
    // this.pause();
    unp_ctx.drawImage(video, 0, 0);
    /*
    this will save as a Blob, less memory consumptive than toDataURL
    a polyfill can be found at
    https://developer.mozilla.org/en-US/docs/Web/API/HTMLCanvasElement/toBlob#Polyfill
    */
    unp_ctx.canvas.toBlob(saveFrame, 'image/jpeg');
    // pro.innerHTML = ((this.currentTime / this.duration) * 100).toFixed(2) + ' %';
    // if (this.currentTime < this.duration) {
    // this.play();
    // }
    // requestAnimationFrame(drawFrame);
  }

  function saveFrame(blob) {
    var fd = new FormData();
    $.ajax({
      method: 'post',
      url: '/frame_upload',
      data: blob,
      processData: false,
      contentType: false,
      success: function(response){
        var bin_img = response['image'];
        img.src = 'data:image/jpeg;base64,' + bin_img
      }
    });
  }

  function revokeURL(e) {
    URL.revokeObjectURL(this.src);
  }

  function onend(e) {
    var img;
    URL.revokeObjectURL(this.src);
  }
</script> -->
